extends ../layout.pug
//- views/estimates/new.pug
block content
  .d-flex.justify-content-center
    form.card.p-4.rounded.shadow(
      action="/estimates", 
      method="POST", 
      style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;"
    )
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Nuevo Presupuesto
        a.btn.btn-gray(href="/estimates", tabindex="9") Volver a la lista

      .row.g-3
        // Columna izquierda
        .col-md-6
          .mb-3
            label.form-label(for="title") Título
            input#title.form-control(type="text", name="title", required, tabindex="1")

          .mb-3
            label.form-label(for="project_id") Proyecto
            select#project_id.form-select(name="project_id", required, tabindex="3")
              if projects && projects.length > 0
                each project in projects
                  option(value=project._id data-client-id=project.client_id._id)= project.name
              else
                option(value="") No hay proyectos disponibles

          .mb-3
            label.form-label(for="currency") Moneda
            select#currency.form-select(name="currency", required, tabindex="5")
              option(value="") Seleccionar una Moneda...
              each label, key in currency_labels
                option(value=key)= label

          .mb-3
            label.form-label(for="subtotal") Subtotal
            input#subtotal.form-control(type="number", name="subtotal", value="0", readonly)

          .mb-3
            label.form-label(for="tax_percent") Impuestos %
            input#tax_percent.form-control(type="number", name="tax_percent", value="21", tabindex="2")

          .mb-3
            label.form-label(for="tax_amount") Monto de impuestos
            input#tax_amount.form-control(type="number", name="tax_amount", value="0", readonly)

          .mb-3 
            label.form-label(for="validity_days") Días de Validez
            input#validity_days.form-control(type="number", name="validity_days", value="15", tabindex="4")

          .mb-3
            label.form-label(for="status") Estado
            select#status.form-select(name="status", required, tabindex="6")
              each label, key in statusLabels
                option(value=key)= label

        // Columna derecha
        .col-md-6
          .mb-3
            label.form-label(for="client_id") Cliente
            select#client_id.form-select(name="client_id", tabindex="2")
              option(value="") -- Seleccionar cliente --
              each client in clients
                option(value=client._id)= client.name

          .mb-3
            label.form-label(for="description") Descripción
            textarea#description.form-control(name="description", tabindex="4")

          // Sección de Ítems
          // Sección de Ítems
          .mb-3
            .d-flex.align-items-center.justify-content-between
              label.form-label(for="estimates_items") Ítems
              button#addItemBtn.btn.btn-primary.btn-sm(type="button") 
                i.bi.bi-plus-circle.me-1
                | Agregar Ítem

            // Tabla separada
            table.table.table-striped.mt-3#itemsTable
              thead
                tr
                  th Descripción
                  th Monto
                  th.text-end(style="width: 1%; white-space: nowrap;") Acciones
              tbody
                tr
                  td(colspan="3" class="text-center text-muted") No hay ítems aún

          // Input oculto
          input(type="hidden", name="items", id="itemsInput")


          .mb-3
            label.form-label(for="discount_percent") Descuento %
            input#discount_percent.form-control(type="number", name="discount_percent", value="0", tabindex="2")

          .mb-3
            label.form-label(for="discount_amount") Monto de descuento
            input#discount_amount.form-control(type="number", name="discount_amount", value="0", readonly)

          .mb-3
            label.form-label(for="total_amount") Monto Total
            input#total_amount.form-control(type="number", name="total_amount", value="0", readonly)

          .mb-3
            label.form-label(for="valid_until") Valido Hasta
            input#valid_until.form-control(type="date", name="valid_until")

      div.mt-3
        button.btn.btn-success(type="submit", tabindex="7") Crear Presupuesto
        a.btn.btn-danger-soft.ms-3(href="/estimates", tabindex="8") Cancelar

 
  // Modal para agregar/editar ítem
  div.modal.fade#itemModal(tabindex='-1', aria-labelledby='itemModalLabel', aria-hidden='true')
    div.modal-dialog
      div.modal-content
        div.modal-header
          h5.modal-title#itemModalLabel Agregar ítem
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Cerrar')
        div.modal-body
          form#itemForm
            input(type='hidden', name='item_id')
            div.mb-3
              label.form-label(for='item_description') Descripción
              input.form-control#item_description(type='text', name='item_description', required)
            div.mb-3
              label.form-label(for='item_amount') Monto
              input.form-control#item_amount(type='number', name='item_amount', step='0.01', required)
            div.text-end
              button.btn.btn-secondary(type="button", data-bs-dismiss="modal") Cancelar
              button.btn.btn-success.ms-3(type="submit") Guardar Ítem

  // Modal de confirmación de eliminación
  div.modal.fade#confirmDeleteModal(tabindex='-1', aria-labelledby='confirmDeleteLabel', aria-hidden='true')
    div.modal-dialog
      div.modal-content
        div.modal-header
          h5.modal-title#confirmDeleteLabel Confirmar Eliminación
          button.btn-close(type='button', data-bs-dismiss='modal', aria-label='Cerrar')
        div.modal-body
          p#confirmDeleteText ¿Está seguro que desea eliminar este ítem?
        div.modal-footer
          button.btn.btn-secondary(type='button', data-bs-dismiss='modal') Cancelar
          button.btn.btn-danger#confirmDeleteBtn(type='button') Eliminar




  //- ======================= SCRIPT UNIFICADO ==========================
  script.
    document.addEventListener('DOMContentLoaded', () => {
      const itemModal = new bootstrap.Modal(document.getElementById('itemModal'));
      const itemForm = document.getElementById('itemForm');
      const itemsTable = document.querySelector('#itemsTable tbody');
      const addItemBtn = document.getElementById('addItemBtn');

      const subtotalInput = document.getElementById('subtotal');
      const discountPercentInput = document.getElementById('discount_percent');
      const discountAmountInput = document.getElementById('discount_amount');
      const taxPercentInput = document.getElementById('tax_percent');
      const taxAmountInput = document.getElementById('tax_amount');
      const totalAmountInput = document.getElementById('total_amount');

      const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
      const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
      let deleteIndex = null;


      // Array inicial
      let items = !{JSON.stringify(item.estimates_items || [])};

      // **Enviar items al backend antes de submit**
      document.querySelector('form').addEventListener('submit', (e) => {
        document.getElementById('itemsInput').value = JSON.stringify(items);
      });

      // Renderizar ítems
      const renderItems = () => {
        itemsTable.innerHTML = '';
        if (items.length === 0) {
          itemsTable.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No hay ítems aún</td></tr>';
        } else {
          items.forEach((it, index) => {
            const row = document.createElement('tr');
            row.dataset.index = index;
            row.innerHTML = `
              <td>${it.description}</td>
              <td>${it.amount.toFixed(2)}</td>
              <td class="text-nowrap">
                <button class="btn btn-warning btn-sm me-1 editItemBtn" type="button">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-danger btn-sm deleteItemBtn" type="button">
                  <i class="bi bi-trash"></i>
                </button>
              </td>`;
            itemsTable.appendChild(row);
          });
        }
        recalcTotals();
      };

      // Recalcular totales
      const recalcTotals = () => {
        const subtotal = items.reduce((acc, it) => acc + it.amount, 0);
        subtotalInput.value = subtotal.toFixed(2);

        const discountPercent = parseFloat(discountPercentInput.value) || 0;
        const discountAmount = subtotal * (discountPercent / 100);
        discountAmountInput.value = discountAmount.toFixed(2);

        const taxPercent = parseFloat(taxPercentInput.value) || 0;
        const taxable = subtotal - discountAmount;
        const taxAmount = taxable * (taxPercent / 100);
        taxAmountInput.value = taxAmount.toFixed(2);

        const total = taxable + taxAmount;
        totalAmountInput.value = total.toFixed(2);
      };

      // Abrir modal (nuevo ítem)
      addItemBtn.addEventListener('click', () => {
        itemForm.reset();
        itemForm.item_id.value = '';
        document.getElementById('itemModalLabel').innerText = 'Agregar ítem';
        itemModal.show();
      });

      // Guardar ítem
      itemForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = itemForm.item_id.value;
        const newItem = {
          description: itemForm.item_description.value.trim(),
          amount: parseFloat(itemForm.item_amount.value)
        };
        if (id) items[id] = newItem;
        else items.push(newItem);
        itemModal.hide();
        renderItems();
      });

      // Editar o eliminar
      // Editar o eliminar
      itemsTable.addEventListener('click', (e) => {
        // Editar ítem
        if (e.target.closest('.editItemBtn')) {
          const row = e.target.closest('tr');
          const index = row.dataset.index;
          const it = items[index];
          itemForm.item_id.value = index;
          itemForm.item_description.value = it.description;
          itemForm.item_amount.value = it.amount;
          document.getElementById('itemModalLabel').innerText = 'Editar ítem';
          itemModal.show();
        }

        // Eliminar ítem con modal
        if (e.target.closest('.deleteItemBtn')) {
          const row = e.target.closest('tr');
          deleteIndex = row.dataset.index;

          // Actualizar texto dinámicamente con el nombre del ítem
          const itemName = items[deleteIndex].description;
          document.getElementById('confirmDeleteText').innerText = `¿Está seguro que desea eliminar el ítem "${itemName}"?`;

          // Mostrar modal de confirmación
          confirmDeleteModal.show();
        }
      });

      // Botón de confirmación del modal
      confirmDeleteBtn.addEventListener('click', () => {
        if (deleteIndex !== null) {
          items.splice(deleteIndex, 1);
          renderItems();
          deleteIndex = null;
          confirmDeleteModal.hide();
        }
      });

      // Inputs de descuento e impuestos
      discountPercentInput.addEventListener('input', recalcTotals);
      taxPercentInput.addEventListener('input', recalcTotals);

      // Render inicial de ítems
      renderItems();
    });

    //- Filtrado dinámico de proyectos según cliente
    document.addEventListener('DOMContentLoaded', () => {
      const clientSelect = document.getElementById('client_id');
      const projectSelect = document.getElementById('project_id');

      const allProjects = !{JSON.stringify(projects || [])};

      // Función para actualizar los proyectos según el cliente seleccionado
      function loadProjectsForClient(clientId) {
        projectSelect.innerHTML = ''; // Limpiar opciones

        if (!clientId) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '-- Selecciona primero un cliente --';
          projectSelect.appendChild(option);
          return;
        }

        const filtered = allProjects.filter(
          p => p.client_id && p.client_id._id === clientId
        );

        if (filtered.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No hay proyectos disponibles para este cliente';
          projectSelect.appendChild(option);
        } else {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = '-- Seleccionar proyecto --';
          projectSelect.appendChild(defaultOption);

          filtered.forEach(project => {
            const option = document.createElement('option');
            option.value = project._id;
            option.textContent = project.name;
            projectSelect.appendChild(option);
          });
        }
      }

      // Estado inicial (sin cliente seleccionado)
      loadProjectsForClient('');

      // Cuando cambia el cliente
      clientSelect.addEventListener('change', () => {
        loadProjectsForClient(clientSelect.value);
      });
    });

    // Lógica para calcular y actualizar la fecha de vencimiento
    document.addEventListener('DOMContentLoaded', () => {
      const validityInput = document.getElementById('validity_days');
      const dueDateInput = document.getElementById('valid_until');

      // Fecha de creación o fecha actual si es nuevo
      const creationDate = new Date(!{JSON.stringify(item.created_at || new Date())});

      function updateDueDate() {
        const days = parseInt(validityInput.value, 10);

        if (!isNaN(days)) {
          const dueDate = new Date(creationDate);
          dueDate.setDate(dueDate.getDate() + days);

          // Formatear como yyyy-mm-dd para el input type=date
          const yyyy = dueDate.getFullYear();
          const mm = String(dueDate.getMonth() + 1).padStart(2, '0');
          const dd = String(dueDate.getDate()).padStart(2, '0');

          dueDateInput.value = `${yyyy}-${mm}-${dd}`;
        } else {
          dueDateInput.value = '';
        }
      }

      // Actualizar al cargar la página
      updateDueDate();

      // Actualizar cuando cambian los días de validez
      validityInput.addEventListener('input', updateDueDate);
    });


