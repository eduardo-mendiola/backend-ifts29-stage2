extends ../layout.pug
//- views/estimates/edit.pug
block content
  .d-flex.justify-content-center
    form.bg-dark.text-white.p-4.rounded.shadow(action=`/estimates/${item.id}?_method=PUT`, method="POST", style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;")
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Editar Presupuesto Código #{item.code}
        a.btn.btn-gray(href="/estimates", tabindex="9") Volver a la lista

      // Contenedor de 2 columnas
      .row.g-3
        // Columna izquierda
        .col-md-6
          .mb-3
            label.form-label(for="title") Título
            input#title.form-control(type="text", name="title", value=item.title || "", required, tabindex="1")
          .mb-3
            label.form-label(for="client_id") Cliente
            select#client_id.form-select(name="client_id", tabindex="3")
              option(value="") -- Seleccionar cliente --
              each client in clients
                option(
                  value=client._id
                  selected=(item.project_id && client._id.toString() === item.project_id.client_id._id.toString())
                ) #{client.name}          
          .mb-3
            label.form-label(for="project_id") Proyecto
            select#project_id.form-select(name="project_id", required, tabindex="5")
              if projects && projects.length > 0
                each project in projects
                  option(
                    value=project._id
                    data-client-id=project.client_id._id
                    selected=(item.project_id && project._id.toString() === item.project_id._id.toString())
                  ) #{project.name}
              else
                option(value="") No hay proyectos disponibles
          .mb-3
            label.form-label(for="description") Descripción
            textarea#description.form-control(name="description", required, tabindex="7")= item.description || ""
          
        // Columna derecha
        .col-md-6
          .mb-3
            label.form-label(for="total_amount") Monto Total
            input#total_amount.form-control(type="number", name="total_amount", value=item.total_amount || "", tabindex="2")
          .mb-3 
            label.form-label(for="validity_days") Días de Validez
            input#validity_days.form-control(type="number", name="validity_days", value=item.validity_days || "", tabindex="4")
          .mb-3
            label.form-label(for="valid_until") Valido Hasta
            input#valid_until.form-control(type="date", name="valid_until", value=item.valid_until)
          .mb-3
            label.form-label(for="status") Estado
            select#status.form-select(name="status", required, tabindex="6")
              if statusLabels
                each label, key in statusLabels
                  option(
                    value=key
                    selected=(item.status && item.status.toString() === key)
                  ) #{label}
              else
                option(value="") No hay estados disponibles
        

      button.btn.btn-success.mt-3(type="submit", tabindex="7") Actualizar Tarea
      a.btn.btn-danger-soft.mt-3.ms-3(href="/estimates", tabindex="8") Cancelar

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const clientSelect = document.getElementById('client_id');
      const projectSelect = document.getElementById('project_id');

      if (!clientSelect || !projectSelect) return;

      // Traer todos los proyectos disponibles del backend
      const allProjects = Array.from(projectSelect.options);

      // Cliente y proyecto actuales (al editar)
      const currentClientId = clientSelect.value || '';
      const currentProjectId = projectSelect.value || '';

      // Función para cargar proyectos según el cliente seleccionado
      function loadProjectsForClient(clientId, keepSelected = false) {
        projectSelect.innerHTML = ''; // limpiar el select

        if (!clientId) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = '-- Selecciona primero un cliente --';
          projectSelect.appendChild(option);
          return;
        }

        // Filtrar proyectos por client_id
        const filtered = allProjects.filter(opt => opt.dataset.clientId === clientId);

        if (filtered.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No hay proyectos disponibles para este cliente';
          projectSelect.appendChild(option);
        } else {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = '-- Seleccionar proyecto --';
          projectSelect.appendChild(defaultOption);

          filtered.forEach(opt => {
            const clone = opt.cloneNode(true);

            // Mantener seleccionado el proyecto actual al cargar (solo al inicio)
            if (keepSelected && clone.value === currentProjectId) {
              clone.selected = true;
            }

            projectSelect.appendChild(clone);
          });
        }
      }

      // Cargar automáticamente los proyectos del cliente actual
      loadProjectsForClient(currentClientId, true);

      // Cuando el usuario cambia el cliente, actualizar proyectos
      clientSelect.addEventListener('change', () => {
        loadProjectsForClient(clientSelect.value);
      });
    });

    document.addEventListener('DOMContentLoaded', () => {
      const validityInput = document.getElementById('validity_days');
      const dueDateInput = document.getElementById('valid_until');

      // Fecha de creación en UTC (del backend)
      const creationDate = new Date(!{JSON.stringify(item.created_at)});

      // Función para formatear fecha en yyyy-mm-dd sin afectar zona horaria
      function formatDateUTC(date) {
        const yyyy = date.getUTCFullYear();
        const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
        const dd = String(date.getUTCDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
      }

      // Función para actualizar la fecha de vencimiento según días de validez
      function updateDueDate() {
        const days = parseInt(validityInput.value, 10);
        if (!isNaN(days)) {
          const newDueDate = new Date(Date.UTC(
            creationDate.getUTCFullYear(),
            creationDate.getUTCMonth(),
            creationDate.getUTCDate() + days
          ));
          dueDateInput.value = formatDateUTC(newDueDate);
        } else {
          dueDateInput.value = '';
        }
      }

      // Inicializar al cargar
      updateDueDate();

      // Actualizar cada vez que cambien los días de validez
      validityInput.addEventListener('input', updateDueDate);

      // Evitar edición manual
      dueDateInput.readOnly = true;
    });
