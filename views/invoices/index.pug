extends ../layout.pug
//- views/estimates/index.pug
block content
  .d-flex.justify-content-between.align-items-center.mb-4
    h1.mb-0 Lista de Facturas
    a.btn.btn-primary(href="/invoices/new") Nueva Factura
    
  //- Incluir barra de búsqueda, modal y JS común
  include ../partials/common-table-scripts.pug

  table.table.table-hover.table-dark.table-index
    thead
      tr
        th №
        th Código
        th № de Factura
        th Cliente
        th Presupuesto
        th Proyecto 
        th Monto Total
        th Estado
        th.text-end.pe-5 Acciones
    tbody
      each item, index in items
        tr(data-id=item.id, data-code=`${item.code}`, data-textmodal1=`Factura №: ${item.invoice_number}`,  data-textmodal2=`Cliente: ${item.client_full_name}`)
          td= index + 1
          td= item.code
          td= item.invoice_number || 'N/A'
          td= item.client_full_name || 'N/A'
          td= item.estimate_id.title || 'N/A'
          td= item.project_name || 'N/A'
          td $#{item.total_amount.toFixed(2)}
          td= statusLabels[item.status] || 'N/A'
          td.text-end
            a.btn.btn-gray.btn-sm.me-2(href=`/invoices/${item.id}`) Ver
            a.btn.btn-sm.me-2(
              class=item.status === 'draft' ? 'btn-gray' : 'btn-success',
              style="width: 65px; text-align:center;",
              href=item.status === 'draft' 
                ? `/invoices/${item.id}/edit`
                : `/invoices/${item.id}/preview`
            )= item.status === 'draft' ? 'Editar' : 'Imprimir'

         
            //- Si está en draft → eliminar
            //- if item.status === 'draft'
            //-   form(
            //-     action=`/api/expenses/${item.id}?_method=DELETE`,
            //-     method="POST",
            //-     style="display:inline;"
            //-   )
            //-     input(type="hidden", name="_method", value="DELETE")
            //-     button.btn.btn-danger-soft.btn-sm.delete-btn(
            //-       type="submit",
            //-       style="width:60px; text-align:center;"
            //-     ) Eliminar
            //- //- Si no → anular
            //- else
            //-   form(
            //-     action=`/invoices/${item.id}/status?_method=PUT`,
            //-     method="POST",
            //-     style="display:inline;"
            //-   )
            //-     input(type="hidden", name="status", value="cancelled")
            //-     button.btn.btn-danger-soft.btn-sm(
            //-       type="submit",
            //-       style="width:60px; text-align:center;"
            //-     ) Anular
            //- Si está en draft → eliminar
            if item.status === 'draft'
              form(
                action=`/api/expenses/${item.id}?_method=DELETE`,
                method="POST",
                style="display:inline;"
              )
                input(type="hidden", name="_method", value="DELETE")
                button.btn.btn-danger-soft.btn-sm.delete-btn(
                  type="submit",
                  style="width:60px; text-align:center;"
                ) Eliminar

            //- Si NO está en draft pero está cancelada → botón deshabilitado
            else if item.status === 'cancelled'
              button.btn.btn-danger-soft.btn-sm(
                disabled,
                style="width:60px; text-align:center; opacity:0.5; cursor:not-allowed;"
              ) Anulada

            //- Si NO está en draft y NO está cancelada → permitir anular
            else
              form(
                action=`/invoices/${item.id}/status?_method=PUT`,
                method="POST",
                style="display:inline;"
              )
                input(type="hidden", name="status", value="cancelled")
                button.btn.btn-danger-soft.btn-sm(
                  type="submit",
                  style="width:60px; text-align:center;"
                ) Anular



