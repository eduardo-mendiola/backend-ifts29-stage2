doctype html
html(lang="es")
  head
    title ClickWare Admin
    meta(charset="utf-8")
    meta(name="viewport", content="width=device-width, initial-scale=1")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css")
    link(rel="stylesheet", href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css")
    link(rel="icon" type="image/x-icon" href="/images/favicon.webp")

    style.
      html, body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        overflow: hidden;
        font-size: 0.9rem;
      }

      body {
        background-color: #121212;
        color: #f0f0f0;
      }

      .main-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Sidebar general */
      .sidebar {
        width: 200px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        background-color: #212529;
        color: white;
        position: sticky;
        top: 0;
      }

      .sidebar-header { flex-shrink: 0; }

      .sidebar-content {
        flex-grow: 1;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .sidebar-content::-webkit-scrollbar {
        width: 6px;
      }
      .sidebar-content::-webkit-scrollbar-thumb {
        background-color: #444;
        border-radius: 3px;
      }
      .sidebar-content::-webkit-scrollbar-thumb:hover {
        background-color: #666;
      }

      .sidebar-footer {
        flex-shrink: 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .btn-gray {
        background-color: #6c757d;
        color: #fff;
      }
      .btn-gray:hover {
        background-color: #5a6268;
        color: #fff;
      }

      .btn-gray:active {
        background-color: #5a6268;
        color: #fff;
        border: 1px solid #579aff46;
      }

      .btn-gray:focus {
        background-color: #4d5357ff;
        color: #fff;
        border: 1px solid #579aff46;
      }

      .btn-gray:focus-visible {
        border: 3px solid #579aff46;
      }


      .btn-danger-soft {
        background-color: #a94442;
        color: #fff;
      }
      .btn-danger-soft:hover {
        background-color: #843534;
        color: #fff;
      }

      .nav-link {
        color: #ffffffb3;
        transition: background-color 0.2s, color 0.2s;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .nav-link:hover {
        background-color: #60606033;
        color: white;
      }

      .nav-link:active {
        background-color: #60606033;
        color: #cececeff !important;
      }

      .nav-link.active {
        background-color: #88888833 !important;
        color: #fff !important;
      }
      
      main {
        flex-grow: 1;
        overflow-y: auto;
        background-color: #121212;
        padding: 1.5rem;
      }

      table {
        background-color: #1e1e1e;
      }

      .table {
        width: 100%;
        background-color: #1e1e1e;
        table-layout: auto;
        word-wrap: break-word;
      }

      .table-index td:first-child,
      .table-index th:first-child {
        width: auto;
        white-space: nowrap;
        text-align: center;
      }

      .table-index td:last-child,
      .table-index th:last-child {
        width: 20%;
        white-space: nowrap;
        text-align: right;
      }

      .table-index .btn {
        display: inline-block;
        margin-bottom: 4px;
      }

      input:focus, textarea:focus, select:focus {
        border-color: #2db96eff !important;
        box-shadow: 0 0 0 0.2rem rgba(171, 255, 189, 1) !important;
        outline: none !important;
      }

  body
    .main-container
      // SIDEBAR IZQUIERDA
      .sidebar
        .sidebar-header.p-3
          a.d-flex.align-items-center.mb-3.mb-md-0.me-md-auto.text-white.text-decoration-none(href="/admin/dashboard")
            img.fs-2.me-2(src="/images/favicon.webp" alt="Logo" width="30px" height="30px" style="height:30px; width:auto;")
            span.fs-4 ClickWare
          hr

        .sidebar-content.px-1
          ul.nav.nav-pills.flex-column.mb-auto
            li.nav-item
              a.nav-link.text-white(href="/admin/dashboard")
                i.bi.bi-house-door.me-2
                | Inicio

            li
              a.nav-link.text-white(href="/projects")
                i.bi.bi-grid.me-2
                | Proyectos
            
            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuClientes" role="button")
                i.bi.bi-people.me-2
                i.bi.bi-caret-down-fill
                |  Usuarios 
                
              ul.collapse#menuClientes.ms-3
                li
                  a.nav-link.text-white(href="/users") Usuarios
                li
                  a.nav-link.text-white(href="/employees") Empleados

            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuClientes" role="button")
                i.bi.bi-people.me-2
                i.bi.bi-caret-down-fill
                |  Clientes y contactos 
                
              ul.collapse#menuClientes.ms-3
                li
                  a.nav-link.text-white(href="/clients") Clientes
                li
                  a.nav-link.text-white(href="/contacts") Contactos

            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuRoles" role="button")
                i.bi.bi-diagram-3.me-2
                i.bi.bi-caret-down-fill
                |  Roles y Cargos 
                
              ul.collapse#menuRoles.ms-3
                li
                  a.nav-link.text-white(href="/roles") Roles
                li
                  a.nav-link.text-white(href="/positions") Cargos

            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuTareas" role="button")
                i.bi.bi-list-check.me-2
                i.bi.bi-caret-down-fill
                |  Actividades 
                
              ul.collapse#menuTareas.ms-3
                li
                  a.nav-link.text-white(href="/tasks") Tareas
                li
                  a.nav-link.text-white(href="/time-entries") Registro de actividades

            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuEquipos" role="button")
                i.bi.bi-people-fill.me-2
                i.bi.bi-caret-down-fill
                |  Equipos 
                
              ul.collapse#menuEquipos.ms-3
                li
                  a.nav-link.text-white(href="/teams") Equipos
                li
                  a.nav-link.text-white(href="/team-roles") Roles de Equipo
                li
                  a.nav-link.text-white(href="/areas") Áreas
            
            li
              a.nav-link.text-white(data-bs-toggle="collapse" href="#menuContabilidad" role="button")
                i.bi.bi-people-fill.me-2
                i.bi.bi-caret-down-fill
                |  Contabilidad 
                
              ul.collapse#menuContabilidad.ms-3
                li
                  a.nav-link.text-white(href="/estimates") Presupuestos
                li
                  a.nav-link.text-white(href="/expenses") Gastos
                li
                  a.nav-link.text-white(href="/expense-categories") Categorías de Gastos
                li
                  a.nav-link.text-white(href="/invoices") Facturas
                li
                  a.nav-link.text-white(href="/payments") Pagos

        .sidebar-footer.p-3
          .dropdown
            a#dropdownUser1.d-flex.align-items-center.text-white.text-decoration-none.dropdown-toggle(
              href="#" data-bs-toggle="dropdown" aria-expanded="false")
              img.rounded-circle.me-2(src="/images/user.png" alt="" width="32" height="32")
              strong Admin
            ul.dropdown-menu.dropdown-menu-dark.text-small.shadow(aria-labelledby="dropdownUser1")
              li
                a.dropdown-item(href="#") Settings
              li
                a.dropdown-item(href="#") Profile
              li
                hr.dropdown-divider
              li
                a.dropdown-item(href="/") Sign out

      main.flex-grow-1.p-4
        block content

    // --- SCRIPTS ---
    script(src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js")

    script.
      // Mantener el estado de los menús colapsables y el enlace activo (solo links reales)
      document.addEventListener('DOMContentLoaded', () => {
        // --- Colapsables ---
        document.querySelectorAll('.collapse').forEach(el => {
          const id = el.id;
          const isOpen = localStorage.getItem(`collapse-${id}`) === 'true';
          if (isOpen) el.classList.add('show');

          const bsCollapse = new bootstrap.Collapse(el, { toggle: false });

          // Guardar estado en localStorage
          el.addEventListener('shown.bs.collapse', () => localStorage.setItem(`collapse-${id}`, 'true'));
          el.addEventListener('hidden.bs.collapse', () => localStorage.setItem(`collapse-${id}`, 'false'));
        });

        // --- Recordar link activo ---
        const sidebarLinks = document.querySelectorAll('.sidebar a.nav-link[href]:not([data-bs-toggle])');

        sidebarLinks.forEach(link => {
          link.addEventListener('click', () => {
            localStorage.setItem('active-link', link.getAttribute('href'));
          });
        });

        const activeHref = localStorage.getItem('active-link');
        if (activeHref) {
          sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === activeHref) {
              link.classList.add('active');
              const parentCollapse = link.closest('.collapse');
              if (parentCollapse) {
                const bsCollapse = new bootstrap.Collapse(parentCollapse, { toggle: false });
                bsCollapse.show();
              }
            } else {
              link.classList.remove('active');
            }
          });
        } else {
          // Si no hay link guardado, resaltar el actual según la URL
          const currentPath = window.location.pathname;
          sidebarLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
              link.classList.add('active');
              const parentCollapse = link.closest('.collapse');
              if (parentCollapse) {
                const bsCollapse = new bootstrap.Collapse(parentCollapse, { toggle: false });
                bsCollapse.show();
              }
            }
          });
        }

        // --- NUEVO: Cambiar íconos de caret según el estado ---
        document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(trigger => {
          const icon = trigger.querySelector('i.bi-caret-down-fill, i.bi-caret-right-fill');
          const targetId = trigger.getAttribute('href')?.replace('#', '');
          const target = document.getElementById(targetId);
          if (!icon || !target) return;

          // Estado inicial
          const isOpen = target.classList.contains('show');
          icon.classList.toggle('bi-caret-down-fill', isOpen);
          icon.classList.toggle('bi-caret-right-fill', !isOpen);

          // Escuchar eventos del colapsable
          target.addEventListener('show.bs.collapse', () => {
            icon.classList.replace('bi-caret-right-fill', 'bi-caret-down-fill');
          });
          target.addEventListener('hide.bs.collapse', () => {
            icon.classList.replace('bi-caret-down-fill', 'bi-caret-right-fill');
          });
        });
      });
