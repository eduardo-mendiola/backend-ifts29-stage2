extends ../layout.pug

block content
  .d-flex.justify-content-center
    form#userEditForm.bg-dark.text-white.p-4.rounded.shadow.needs-validation(action=`/users/${item.id}?_method=PUT`, method="POST", style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;", novalidate)
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Editar Usuario
        a.btn.btn-gray(href="/users", tabindex="7") Volver a la lista

      // Contenedor de 2 columnas
      .row.g-3
        // Columna izquierda
        .col-md-6
          .mb-3
            label.form-label(for="email") Email
            input#email.form-control(
              type="email", 
              name="email", 
              value=item.email || "", 
              required, 
              tabindex="1",
              pattern="^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$"
            )
            .invalid-feedback Por favor ingresa un email válido con dominio completo (ej: usuario@dominio.com)
          .mb-3
            label.form-label(for="username") Nombre de usuario
            input#username.form-control(
              type="text", 
              name="username", 
              value=item.username || "", 
              required, 
              tabindex="3",
              minlength="3",
              title="Mínimo 3 caracteres"
            )
          .mb-3
            label.form-label(for="password_hash") Contraseña (dejar en blanco para no cambiar)
            input#password_hash.form-control(
              type="password", 
              name="password_hash", 
              placeholder="••••••••",
              tabindex="5",
              minlength="6",
              title="Mínimo 6 caracteres. Dejar vacío si no deseas cambiarla"
            ) 

        // Columna derecha
        .col-md-6
          .mb-3
            label.form-label(for="role_id") Rol (acceso)
            select#role_id.form-select(name="role_id", required, tabindex="2")
              each role in roles
                option(
                  value=role._id 
                  selected=(item.role_id && role._id.toString() === item.role_id._id.toString())
                ) #{role.name}
          .mb-3
            label.form-label(for="is_active") Estado
            select#is_active.form-select(name="is_active", required, tabindex="4")
              option(value="true" selected=(item.is_active === true)) Activo
              option(value="false" selected=(item.is_active === false)) Inactivo

      //- Sección de Rol Temporal
      .row.mt-4
        .col-12
          .card.bg-secondary.border-info
            .card-header.bg-info.text-white
              h5.mb-0
                i.bi.bi-clock-history.me-2
                | Configuración de Rol Temporal
            .card-body
              if item.is_temporary_role
                .alert.alert-warning.d-flex.align-items-center
                  i.bi.bi-exclamation-triangle-fill.me-2
                  div
                    strong Este usuario tiene un rol temporal activo
                    br
                    | Expira: #{item.role_expiration_date ? new Date(item.role_expiration_date).toLocaleString('es-AR') : 'N/A'}
                    br
                    | Rol de fallback: 
                    if item.fallback_role_id
                      | #{item.fallback_role_id.name || 'No configurado'}
                    else
                      | No configurado
              
              .form-check.mb-3
                input#is_temporary_role.form-check-input(
                  type="checkbox" 
                  name="is_temporary_role"
                  checked=(item.is_temporary_role === true)
                  onchange="toggleTemporaryRoleFields(this)"
                )
                label.form-check-label.text-white(for="is_temporary_role")
                  | Asignar rol temporal con expiración automática
              
              #temporaryRoleFields(style=item.is_temporary_role ? "display: block;" : "display: none;")
                .row.g-3
                  .col-md-4
                    label.form-label.text-white(for="role_duration_value") Duración
                    input#role_duration_value.form-control(
                      type="number" 
                      name="role_duration_value"
                      min="1"
                      value=item.role_duration_value || ""
                      placeholder="Ej: 15"
                    )
                    .form-text.text-light Cantidad de tiempo
                  
                  .col-md-4
                    label.form-label.text-white(for="role_duration_unit") Unidad de tiempo
                    select#role_duration_unit.form-select(name="role_duration_unit")
                      option(value="seconds" selected=(item.role_duration_unit === 'seconds')) Segundos
                      option(value="minutes" selected=(item.role_duration_unit === 'minutes')) Minutos
                      option(value="hours" selected=(item.role_duration_unit === 'hours')) Horas
                      option(value="days" selected=(item.role_duration_unit === 'days' || !item.role_duration_unit)) Días
                      option(value="months" selected=(item.role_duration_unit === 'months')) Meses
                  
                  .col-md-4
                    label.form-label.text-white(for="fallback_role_id") Rol después de expirar
                    select#fallback_role_id.form-select(name="fallback_role_id")
                      option(value="") -- Seleccionar rol --
                      each role in roles
                        option(
                          value=role._id
                          selected=(item.fallback_role_id && role._id.toString() === item.fallback_role_id._id.toString())
                        ) #{role.name}
                    .form-text.text-light El usuario pasará a este rol automáticamente
                
                .col-md-12.mt-3
                  .alert.alert-info.d-flex.align-items-center
                    i.bi.bi-clock-fill.me-2
                    div
                      strong Nueva fecha de expiración calculada:
                      |  
                      span#expirationPreview.fw-bold Seleccione duración y unidad de tiempo
          
         
      button.btn.btn-success.mt-3(type="submit", tabindex="5") Actualizar Usuario
      a.btn.btn-danger-soft.mt-3.ms-3(href="/users", tabindex="6") Cancelar

  script.
    // Mostrar/ocultar campos de rol temporal
    function toggleTemporaryRoleFields(checkbox) {
      const fields = document.getElementById('temporaryRoleFields');
      const durationValue = document.getElementById('role_duration_value');
      const fallbackRole = document.getElementById('fallback_role_id');
      
      if (checkbox.checked) {
        fields.style.display = 'block';
        durationValue.required = true;
        fallbackRole.required = true;
        updateExpirationPreview();
      } else {
        fields.style.display = 'none';
        durationValue.required = false;
        fallbackRole.required = false;
      }
    }
    
    // Calcular y mostrar la fecha de expiración en tiempo real
    function updateExpirationPreview() {
      const value = document.getElementById('role_duration_value').value;
      const unit = document.getElementById('role_duration_unit').value;
      const preview = document.getElementById('expirationPreview');
      
      if (!value || value <= 0) {
        preview.textContent = 'Seleccione duración y unidad de tiempo';
        preview.className = 'fw-bold';
        return;
      }
      
      const now = new Date();
      const expiration = new Date(now);
      
      switch(unit) {
        case 'seconds':
          expiration.setSeconds(expiration.getSeconds() + parseInt(value));
          break;
        case 'minutes':
          expiration.setMinutes(expiration.getMinutes() + parseInt(value));
          break;
        case 'hours':
          expiration.setHours(expiration.getHours() + parseInt(value));
          break;
        case 'days':
          expiration.setDate(expiration.getDate() + parseInt(value));
          break;
        case 'months':
          expiration.setMonth(expiration.getMonth() + parseInt(value));
          break;
      }
      
      // Formato: "23/11/2025, 15:45:30"
      const formatted = expiration.toLocaleString('es-AR', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      preview.textContent = formatted;
      preview.className = 'fw-bold text-success';
    }
    
    // Vincular eventos para actualización en tiempo real
    document.addEventListener('DOMContentLoaded', function() {
      const durationValue = document.getElementById('role_duration_value');
      const durationUnit = document.getElementById('role_duration_unit');
      
      if (durationValue && durationUnit) {
        durationValue.addEventListener('input', updateExpirationPreview);
        durationUnit.addEventListener('change', updateExpirationPreview);
        
        // Si ya hay valores (modo edición), calcular inmediatamente
        if (durationValue.value) {
          updateExpirationPreview();
        }
      }
    });
    
    // Validación de Bootstrap en tiempo real
    (function() {
      'use strict';
      const form = document.getElementById('userEditForm');
      const emailInput = document.getElementById('email');
      
      // Validar en tiempo real mientras escribes
      emailInput.addEventListener('input', function() {
        if (this.checkValidity()) {
          this.classList.remove('is-invalid');
          this.classList.add('is-valid');
        } else {
          this.classList.remove('is-valid');
          this.classList.add('is-invalid');
        }
      });
      
      // Validar al enviar
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    })();