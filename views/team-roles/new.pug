extends ../layout.pug
//- views/team_role/new.pug
block content
  .d-flex.justify-content-center
    form#teamRoleForm.bg-dark.text-white.p-4.rounded.shadow(
      style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;"
    )
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Crear Nuevo Rol de Equipo
        a.btn.btn-gray(href="/team-roles", tabindex="5") Volver a la lista

      .row.g-3
        .col-md-6
          .mb-3
            label.form-label(for="name") Título del Rol de Equipo
            input#name.form-control(type="text", name="name", required, tabindex="1")
          .mb-3
            label.form-label(for="description") Descripción
            textarea#description.form-control(name="description", tabindex="2")

      .mb-3
        // Contenedor para mostrar alert dinámico
        div#alertContainer

      button.btn.btn-primary.mt-3(type="submit", tabindex="3") Crear Rol de Equipo
      a.btn.btn-danger-soft.mt-3.ms-3(href="/team-roles", tabindex="4") Cancelar

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('teamRoleForm');
      const alertContainer = document.getElementById('alertContainer');
      const itemId = '!{item.id}'; // Pug interpolación segura

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        alertContainer.innerHTML = ''; // limpiar alert previo

        const formData = new FormData(form);
        const data = {};
        formData.forEach((value, key) => data[key] = value);

        try {
          const response = await fetch('/team-roles', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          let result;
          try {
            result = await response.json();
          } catch {
            result = { success: response.ok, message: response.statusText || 'Error inesperado' };
            console.log(result.message);
          }

          if (!result.success) {
            // Mostrar alerta solo si hubo error
            const div = document.createElement('div');
            div.className = 'alert alert-danger';
            div.textContent = result.message || "El nombre del rol ya existe intente con otro.";
            alertContainer.appendChild(div);
          } else {
            // Redirigir directamente si todo está bien
            //window.location.href = `/team-roles/${itemId}`;
            window.location.href = result.redirectUrl;
          }

        } catch (error) {
          console.error('Error inesperado:', error);
          const div = document.createElement('div');
          div.className = 'alert alert-danger';
          div.textContent = 'Error inesperado al guardar el rol';
          alertContainer.appendChild(div);
        }
      });

      // Borrar alert cuando usuario cambia cualquier input
      form.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', () => {
          alertContainer.innerHTML = '';
        });
      });
    });
