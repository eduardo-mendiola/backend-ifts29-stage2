extends ../layout.pug
//- views/receipts/edit.pug
block content
  .d-flex.justify-content-center
    form.bg-dark.text-white.p-4.rounded.shadow(action=`/receipts/${item.id}?_method=PUT`, method="POST", style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;")
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Editar Cobro
        a.btn.btn-gray(href="/receipts", tabindex="11") Volver a la lista

      // Contenedor de 2 columnas
      .row.g-3
        // Columna izquierda
        .col-md-6
          .mb-3
            label.form-label(for="client_id") Cliente
            select#client_id.form-select(name="client_id", tabindex="1")
              option(value="") -- Seleccionar cliente --
              each client in clients
                option(
                  value=client._id
                  selected=(item.invoice_id && item.invoice_id.estimate_id && item.invoice_id.estimate_id.project_id && item.invoice_id.estimate_id.project_id.client_id && client._id.toString() === item.invoice_id.estimate_id.project_id.client_id._id.toString())
                ) #{client.name}

          .mb-3
            label.form-label(for="invoice_id") Factura 
            select#invoice_id.form-select(name="invoice_id", required, tabindex="3")
              option(value="") Seleccionar una factura...
              if invoices && invoices.length > 0
                each invoice in invoices
                  option(
                    value=invoice._id
                    data-estimate-id=invoice.estimate_id._id
                    selected=(item.invoice_id && invoice._id.toString() === item.invoice_id._id.toString())
                  ) #{invoice.invoice_number} - $#{invoice.total_amount} - #{invoice.estimate_id.clientName} - #{invoice.estimate_id.projectName}
  
          .mb-3
            label.form-label(for="currency") Moneda
            select#currency.form-select(name="currency", required, tabindex="5")
              option(value="") Seleccionar una Moneda...
              if currency_labels
                each label, key in currency_labels
                  option(
                    value=key
                    selected=(item.currency && item.currency.toString() === key)
                  ) #{label}
              else
                option(value="") No hay monedas disponibles
            
          .mb-3
            label.form-label(for="amount") Monto Total ($)
            input#amount.form-control(type="number", name="amount", value=item.amount || "", tabindex="7")

        // Columna derecha
        .col-md-6
          .mb-3
            label.form-label(for="estimate_id") Presupuesto / Proyecto
            select#estimate_id.form-select(name="estimate_id", required, tabindex="2")
              if estimates && estimates.length > 0
                each estimate in estimates
                  option(
                    value=estimate._id
                    data-client-id=estimate.project_id.client_id._id
                    selected=(item.invoice_id && item.invoice_id.estimate_id && estimate._id.toString() === item.invoice_id.estimate_id._id.toString())
                  ) #{estimate.title} / #{estimate.project_id.name}
              else
                option(value="") No hay proyectos disponibles
          
          .mb-3
            label.form-label(for="payment_date") Fecha de Pago
            input#payment_date.form-control(type="date", name="payment_date", value=item.payment_date || "", tabindex="4")

          .mb-3
            label.form-label(for="transaction_id") Código de Transacción
            input#transaction_id.form-control(type="text", name="transaction_id", value=item.transaction_id || "", tabindex="6")

          .mb-3
            label.form-label(for="payment_method") Método de Pago
            select#payment_method.form-select(name="payment_method", required, tabindex="8")
              option(value="") Seleccionar un Método de Pago...
              if payment_method_labels
                each label, key in payment_method_labels
                  option(
                    value=key
                    selected=(item.payment_method && item.payment_method.toString() === key)
                  ) #{label}
              else
                option(value="") No hay métodos de pago disponibles

      button.btn.btn-success.mt-3(type="submit", tabindex="9") Actualizar Cobro
      a.btn.btn-danger-soft.mt-3.ms-3(href="/receipts", tabindex="10") Cancelar

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const clientSelect    = document.getElementById('client_id');
      const estimateSelect  = document.getElementById('estimate_id');
      const invoiceSelect   = document.getElementById('invoice_id');

      if (!clientSelect || !estimateSelect || !invoiceSelect) return;

      // Guardar opciones originales
      const allEstimates = Array.from(estimateSelect.options);
      const allInvoices  = Array.from(invoiceSelect.options);

      // Valores actuales (modo edición) - Mejorar la obtención de valores
      let currentClientId   = '';
      let currentEstimateId = '';
      let currentInvoiceId  = '';

      // Obtener IDs de manera más robusta
      if (clientSelect.value) {
        currentClientId = clientSelect.value.toString();
      }
      
      const selectedEstimate = estimateSelect.querySelector('option[selected]');
      if (selectedEstimate) {
        currentEstimateId = selectedEstimate.value.toString();
      }
      
      const selectedInvoice = invoiceSelect.querySelector('option[selected]');
      if (selectedInvoice) {
        currentInvoiceId = selectedInvoice.value.toString();
      }

      // Debug - agregar logs para verificar valores
      console.log('Valores actuales:', {
        clientId: currentClientId,
        estimateId: currentEstimateId,
        invoiceId: currentInvoiceId
      });

      // --- FILTRADO DE PROYECTOS ---
      function loadEstimatesForClient(clientId, keepSelected = false) {
        console.log('Loading estimates for client:', clientId);
        estimateSelect.innerHTML = '';

        if (!clientId) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '-- Selecciona primero un cliente --';
          estimateSelect.appendChild(opt);
          return;
        }

        const filtered = allEstimates.filter(opt => {
          const optClientId = (opt.dataset?.clientId || '').toString();
          console.log('Comparing:', optClientId, 'with', clientId.toString());
          return optClientId === clientId.toString();
        });

        console.log('Filtered estimates:', filtered.length);

        if (filtered.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No hay proyectos disponibles para este cliente';
          estimateSelect.appendChild(opt);
        } else {
          const def = document.createElement('option');
          def.value = '';
          def.textContent = '-- Seleccionar proyecto --';
          estimateSelect.appendChild(def);

          filtered.forEach(opt => {
            const clone = opt.cloneNode(true);
            if (keepSelected && clone.value.toString() === currentEstimateId) {
              clone.selected = true;
              console.log('Selected estimate:', clone.value);
            }
            estimateSelect.appendChild(clone);
          });
        }
      }

      // --- FILTRADO DE FACTURAS POR PROYECTO ---
      function loadInvoicesForEstimate(estimateId, keepSelected = false) {
        console.log('Loading invoices for estimate:', estimateId);
        invoiceSelect.innerHTML = '';

        if (!estimateId) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '-- Selecciona primero un proyecto --';
          invoiceSelect.appendChild(opt);
          return;
        }

        const filtered = allInvoices.filter(opt => {
          const optEstimateId = (opt.dataset?.estimateId || '').toString();
          return optEstimateId === estimateId.toString();
        });

        console.log('Filtered invoices:', filtered.length);

        if (filtered.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No hay facturas disponibles para este proyecto';
          invoiceSelect.appendChild(opt);
        } else {
          const def = document.createElement('option');
          def.value = '';
          def.textContent = '-- Seleccionar factura --';
          invoiceSelect.appendChild(def);

          filtered.forEach(opt => {
            const clone = opt.cloneNode(true);
            if (keepSelected && clone.value.toString() === currentInvoiceId) {
              clone.selected = true;
              console.log('Selected invoice:', clone.value);
            }
            invoiceSelect.appendChild(clone);
          });
        }
      }

      // --- EVENTOS ---
      clientSelect.addEventListener('change', () => {
        loadEstimatesForClient(clientSelect.value, false);
        loadInvoicesForEstimate('', false); // limpiamos facturas
      });

      estimateSelect.addEventListener('change', () => {
        loadInvoicesForEstimate(estimateSelect.value, false);
      });

      // --- INICIALIZACIÓN CUANDO SE EDITA ---
      if (currentClientId) {
        console.log('Initializing with client:', currentClientId);
        loadEstimatesForClient(currentClientId, true);
        
        // Dar tiempo para que se carguen los estimates antes de cargar invoices
        setTimeout(() => {
          if (currentEstimateId) {
            loadInvoicesForEstimate(currentEstimateId, true);
          }
        }, 100);
      } else {
        loadEstimatesForClient('', false);
        loadInvoicesForEstimate('', false);
      }
    });