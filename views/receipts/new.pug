extends ../layout.pug
//- views/receipts/new.pug
block content
  .d-flex.justify-content-center
    form.bg-dark.text-white.p-4.rounded.shadow(action="/receipts", method="POST", style="width:100%; max-width:1200px; max-height:100vh; overflow-y:auto;")
      .d-flex.justify-content-between.align-items-center.mb-3
        h1.mb-0 Nuevo Cobro
        a.btn.btn-gray(href="/receipts", tabindex="11") Volver a la lista

      // Contenedor de 2 columnas
      .row.g-3
        // Columna izquierda
        .col-md-6
          .mb-3
            label.form-label(for="client_id") Cliente
            select#client_id.form-select(name="client_id", tabindex="1")
              option(value="") -- Selecciona un cliente --
              each client in clients
                option(value=client._id) #{client.name}

          .mb-3
            label.form-label(for="invoice_id") Factura
            select#invoice_id.form-select(name="invoice_id", required, tabindex="3")
              option(value="") -- Selecciona una factura --
              if invoices && invoices.length > 0
                each invoice in invoices
                  option(
                    value=invoice._id
                    data-estimate-id=invoice.estimate_id._id
                  ) #{invoice.invoice_number} - $#{invoice.total_amount} - #{invoice.estimate_id.clientName} - #{invoice.estimate_id.projectName}


          .mb-3
            label.form-label(for="currency") Moneda
            select#currency.form-select(name="currency", required, tabindex="5")
              option(value="") -- Seleccionar una Moneda --
              if currency_labels
                each label, key in currency_labels
                  option(value=key) #{label}
              else
                option(value="") No hay monedas disponibles

          .mb-3
            label.form-label(for="amount") Monto Total ($)
            input#amount.form-control(type="number", name="amount", value="", tabindex="7")

        // Columna derecha
        .col-md-6
          .mb-3
            label.form-label(for="estimate_id") Presupuesto / Proyecto
            select#estimate_id.form-select(name="estimate_id", required, tabindex="2")
              option(value="") -- Selecciona un proyecto --
              if estimates && estimates.length > 0
                each estimate in estimates
                  option(
                    value=estimate._id
                    data-client-id=estimate.project_id.client_id._id
                  ) #{estimate.title} / #{estimate.project_id.name}

          .mb-3
            label.form-label(for="payment_date") Fecha de Pago
            - var today = new Date().toISOString().slice(0,10)
            input#payment_date.form-control(type="date", name="payment_date", value=today, tabindex="4")

          .mb-3
            label.form-label(for="transaction_id") Código de Transacción
            input#transaction_id.form-control(type="text", name="transaction_id", value=item.transaction_id || "", tabindex="6")


          .mb-3
            label.form-label(for="payment_method") Método de Pago
            select#payment_method.form-select(name="payment_method", required, tabindex="8")
              option(value="") -- Seleccionar un Método de Pago --
              if payment_method_labels
                each label, key in payment_method_labels
                  option(value=key) #{label}
              else
                option(value="") No hay métodos de pago disponibles

      button.btn.btn-success.mt-3(type="submit", tabindex="9") Crear Cobro
      a.btn.btn-danger-soft.mt-3.ms-3(href="/receipts", tabindex="10") Cancelar

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const clientSelect    = document.getElementById('client_id');
      const estimateSelect  = document.getElementById('estimate_id');
      const invoiceSelect   = document.getElementById('invoice_id');

      if (!clientSelect || !estimateSelect || !invoiceSelect) return;

      // Guardar todas las opciones originales
      const allEstimates = Array.from(estimateSelect.options);
      const allInvoices  = Array.from(invoiceSelect.options);

      // --- FILTRADO DE PROYECTOS ---
      function loadEstimatesForClient(clientId) {
        estimateSelect.innerHTML = '';

        if (!clientId) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '-- Selecciona primero un cliente --';
          estimateSelect.appendChild(opt);
          return;
        }

        const filtered = allEstimates.filter(opt => (opt.dataset?.clientId || '').toString() === clientId.toString());

        if (filtered.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No hay proyectos disponibles para este cliente';
          estimateSelect.appendChild(opt);
        } else {
          const def = document.createElement('option');
          def.value = '';
          def.textContent = '-- Seleccionar proyecto --';
          estimateSelect.appendChild(def);

          filtered.forEach(opt => estimateSelect.appendChild(opt.cloneNode(true)));
        }
      }

      // --- FILTRADO DE FACTURAS POR PROYECTO ---
      function loadInvoicesForEstimate(estimateId) {
        invoiceSelect.innerHTML = '';

        if (!estimateId) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = '-- Selecciona primero un proyecto --';
          invoiceSelect.appendChild(opt);
          return;
        }

        const filtered = allInvoices.filter(opt => (opt.dataset?.estimateId || '').toString() === estimateId.toString());

        if (filtered.length === 0) {
          const opt = document.createElement('option');
          opt.value = '';
          opt.textContent = 'No hay facturas disponibles para este proyecto';
          invoiceSelect.appendChild(opt);
        } else {
          const def = document.createElement('option');
          def.value = '';
          def.textContent = '-- Seleccionar factura --';
          invoiceSelect.appendChild(def);

          filtered.forEach(opt => invoiceSelect.appendChild(opt.cloneNode(true)));
        }
      }

      // --- EVENTOS ---
      clientSelect.addEventListener('change', () => {
        loadEstimatesForClient(clientSelect.value);
        loadInvoicesForEstimate(''); // limpiar facturas
      });

      estimateSelect.addEventListener('change', () => {
        loadInvoicesForEstimate(estimateSelect.value);
      });

      // --- INICIALIZACIÓN ---
      loadEstimatesForClient('', false);
      loadInvoicesForEstimate('', false);
    });
